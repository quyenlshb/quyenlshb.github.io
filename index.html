<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trắc nghiệm từ vựng tiếng Nhật</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f0f4f8;
            color: #2c3e50;
            flex-direction: column;
            padding: 20px;
        }

        .card-container {
            width: 90%;
            max-width: 600px;
            text-align: center;
            padding: 30px;
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .japanese-word {
            font-size: 3em;
            font-weight: 700;
            margin-bottom: 20px;
            color: #34495e;
            transition: opacity 0.5s ease-in-out;
        }

        .romaji {
            font-size: 1.2em;
            color: #7f8c8d;
            margin-bottom: 30px;
        }

        .options-container {
            display: grid;
            gap: 15px;
            grid-template-columns: 1fr;
        }

        .option-button {
            padding: 15px 25px;
            font-size: 1.1em;
            font-weight: 700;
            color: #2c3e50;
            background-color: #ecf0f1;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease;
            text-align: left;
        }

        .option-button:hover {
            background-color: #d8e1e7;
        }

        .option-button:active {
            transform: translateY(1px);
        }

        .option-button.correct {
            background-color: #27ae60;
            color: white;
            border-color: #2ecc71;
        }

        .option-button.incorrect {
            background-color: #e74c3c;
            color: white;
            border-color: #c0392b;
        }

        .result-message {
            margin-top: 20px;
            font-size: 1.2em;
            font-weight: 700;
            color: #3498db;
            min-height: 1.5em;
        }

        .navigation-panel {
            margin-top: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            max-width: 600px;
        }

        .nav-button {
            padding: 12px 25px;
            font-size: 1em;
            font-weight: 700;
            color: white;
            background-color: #3498db;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease;
        }

        .nav-button:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
        }

        .nav-button:active {
            transform: translateY(0);
        }
        
        .hidden {
            display: none;
        }

        .counter {
            font-size: 1em;
            color: #7f8c8d;
        }

        /* Home Page specific styles */
        .home-page .option-button {
            display: block;
            width: 100%;
            text-align: center;
            margin-bottom: 15px;
        }

        .home-page h1 {
            font-size: 2.5em;
        }
        
        .home-page p {
            font-size: 1.2em;
            margin-bottom: 25px;
        }

        /* Custom Quiz Input styles */
        .custom-quiz-input-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .custom-quiz-input-container input {
            flex-grow: 1;
            padding: 10px;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            font-size: 1em;
            box-sizing: border-box;
            text-align: center;
        }
        .custom-quiz-input-container .option-button {
            width: auto; /* Reset width for flex container */
        }


        /* Add Word Page styles */
        #add-word-page {
            text-align: left;
        }
        #add-word-page input {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            font-size: 1em;
            box-sizing: border-box;
        }
        #add-word-page label {
            font-weight: 700;
            margin-bottom: 5px;
            display: block;
        }
        #add-word-page #add-button {
            width: 100%;
            background-color: #2ecc71;
            color: white;
        }

        .score-container {
            margin-top: 10px;
            text-align: right;
            font-size: 1em;
            font-weight: 700;
        }
        
        .score-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #ecf0f1;
        }
        .score-item:last-child {
            border-bottom: none;
        }


        /* Responsive design */
        @media (min-width: 600px) {
            .options-container {
                grid-template-columns: 1fr 1fr;
            }
            .home-page .options-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

    <!-- Trang chủ -->
    <div id="home-page" class="card-container home-page">
        <h1>Chào mừng đến với web của Quyền</h1>
        <p>Chọn số lượng từ bạn muốn học trong mỗi lần trắc nghiệm.</p>
        <div class="options-container">
            <button class="option-button" data-quiz-size="15">Học 15 từ</button>
            <button class="option-button" data-quiz-size="20">Học 20 từ</button>
            <div class="custom-quiz-input-container">
                <input type="number" id="custom-quiz-input" placeholder="Số từ">
                <button class="nav-button" id="start-custom-quiz">Bắt đầu</button>
            </div>
            <button class="option-button" id="add-word-option">Thêm từ mới</button>
        </div>
    </div>

    <!-- Trang thêm từ mới -->
    <div id="add-word-page" class="card-container hidden">
        <h2>Thêm từ vựng mới</h2>
        <label for="japanese-input">Từ tiếng Nhật:</label>
        <input type="text" id="japanese-input" placeholder="Nhập từ tiếng Nhật (ví dụ: こんにちは)">
        <label for="romaji-input">Romaji:</label>
        <input type="text" id="romaji-input" placeholder="Nhập romaji (ví dụ: konnichiwa)">
        <label for="vietnamese-input">Nghĩa tiếng Việt:</label>
        <input type="text" id="vietnamese-input" placeholder="Nhập nghĩa tiếng Việt (ví dụ: Xin chào)">
        <button class="nav-button" id="add-button">Thêm từ</button>
        <div id="add-message" style="margin-top: 15px; color: #2ecc71;"></div>
    </div>

    <!-- Trang trắc nghiệm -->
    <div id="quiz-page" class="card-container hidden">
        <h1 class="japanese-word" id="japanese-word"></h1>
        <p class="romaji" id="romaji"></p>
        
        <div class="options-container" id="options-container">
            <!-- Buttons will be generated by JavaScript -->
        </div>

        <p class="result-message" id="result-message"></p>
        
        <div id="word-scores-breakdown" class="hidden">
            <h3>Chi tiết điểm số:</h3>
        </div>
    </div>

    <div id="quiz-navigation" class="navigation-panel hidden">
        <button id="back-button" class="nav-button">Trang chủ</button>
        <div style="text-align: center;">
            <span class="counter" id="counter"></span>
            <div class="score-container">Tổng điểm: <span id="score-display">0</span></div>
        </div>
        <button id="next-button" class="nav-button hidden">Tiếp theo</button>
    </div>

    <script>
        // Danh sách 50 từ tiếng Nhật ban đầu
        const initialVocabulary = [
            { japanese: 'こんにちは', romaji: 'konnichiwa', vietnamese: 'Xin chào' },
            { japanese: 'ありがとう', romaji: 'arigatou', vietnamese: 'Cảm ơn' },
            { japanese: 'すみません', romaji: 'sumimasen', vietnamese: 'Xin lỗi / Xin phép' },
            { japanese: 'はい', romaji: 'hai', vietnamese: 'Vâng / Có' },
            { japanese: 'いいえ', romaji: 'iie', vietnamese: 'Không' },
            { japanese: 'おはようございます', romaji: 'ohayou gozaimasu', vietnamese: 'Chào buổi sáng' },
            { japanese: 'こんばんは', romaji: 'konbanwa', vietnamese: 'Chào buổi tối' },
            { japanese: 'おやすみなさい', romaji: 'oyasuminasai', vietnamese: 'Chúc ngủ ngon' },
            { japanese: 'さようなら', romaji: 'sayounara', vietnamese: 'Tạm biệt' },
            { japanese: 'はじめまして', romaji: 'hajimemashite', vietnamese: 'Rất vui được gặp bạn' },
            { japanese: 'おねがいします', romaji: 'onegaishimasu', vietnamese: 'Làm ơn / Xin vui lòng' },
            { japanese: 'いただきます', romaji: 'itadakimasu', vietnamese: 'Mời ăn cơm' },
            { japanese: 'ごちそうさま', romaji: 'gochisousama', vietnamese: 'Cảm ơn vì bữa ăn' },
            { japanese: 'おいしい', romaji: 'oishii', vietnamese: 'Ngon' },
            { japanese: 'かわいい', romaji: 'kawaii', vietnamese: 'Dễ thương' },
            { japanese: 'すごい', romaji: 'sugoi', vietnamese: 'Tuyệt vời / Kinh ngạc' },
            { japanese: 'がんばって', romaji: 'ganbatte', vietnamese: 'Cố lên' },
            { japanese: 'おげんきですか', romaji: 'ogenki desu ka', vietnamese: 'Bạn có khỏe không?' },
            { japanese: 'わたし', romaji: 'watashi', vietnamese: 'Tôi' },
            { japanese: 'あなた', romaji: 'anata', vietnamese: 'Bạn' },
            { japanese: 'これ', romaji: 'kore', vietnamese: 'Cái này' },
            { japanese: 'それ', romaji: 'sore', vietnamese: 'Cái đó' },
            { japanese: 'あれ', romaji: 'are', vietnamese: 'Cái kia' },
            { japanese: 'どこ', romaji: 'doko', vietnamese: 'Ở đâu' },
            { japanese: 'いつ', romaji: 'itsu', vietnamese: 'Khi nào' },
            { japanese: 'いくら', romaji: 'ikura', vietnamese: 'Bao nhiêu tiền' },
            { japanese: 'なん', romaji: 'nan', vietnamese: 'Cái gì' },
            { japanese: 'だれ', romaji: 'dare', vietnamese: 'Ai' },
            { japanese: 'どうして', romaji: 'doushite', vietnamese: 'Tại sao' },
            { japanese: 'どうも', romaji: 'doumo', vietnamese: 'Cảm ơn / Chào' },
            { japanese: 'どうぞ', romaji: 'douzo', vietnamese: 'Xin mời' },
            { japanese: 'おはよう', romaji: 'ohayou', vietnamese: 'Chào buổi sáng (thân mật)' },
            { japanese: 'げんき', romaji: 'genki', vietnamese: 'Khỏe' },
            { japanese: 'しごと', romaji: 'shigoto', vietnamese: 'Công việc' },
            { japanese: 'がっこう', romaji: 'gakkou', vietnamese: 'Trường học' },
            { japanese: 'おみやげ', romaji: 'omiyage', vietnamese: 'Quà lưu niệm' },
            { japanese: 'おかし', romaji: 'okashi', vietnamese: 'Kẹo, bánh' },
            { japanese: 'おさけ', romaji: 'osake', vietnamese: 'Rượu sake' },
            { japanese: 'ごはん', romaji: 'gohan', vietnamese: 'Cơm' },
            { japanese: 'みず', romaji: 'mizu', vietnamese: 'Nước' },
            { japanese: 'おちゃ', romaji: 'ocha', vietnamese: 'Trà' },
            { japanese: 'にほんご', romaji: 'nihongo', vietnamese: 'Tiếng Nhật' },
            { japanese: 'えいご', romaji: 'eigo', vietnamese: 'Tiếng Anh' },
            { japanese: 'わたしは', romaji: 'watashi wa', vietnamese: 'Tôi là...' },
            { japanese: '〜です', romaji: 'desu', vietnamese: 'Là (trợ động từ)' },
            { japanese: 'はい、そうです', romaji: 'hai, sou desu', vietnamese: 'Vâng, đúng vậy' },
            { japanese: 'いいえ、ちがいます', romaji: 'iie, chigaimasu', vietnamese: 'Không, không phải' },
            { japanese: 'おつかれさま', romaji: 'otsukaresama', vietnamese: 'Bạn vất vả rồi' },
            { japanese: 'どうぞよろしく', romaji: 'douzo yoroshiku', vietnamese: 'Rất mong được giúp đỡ' },
            { japanese: 'いってきます', romaji: 'ittekimasu', vietnamese: 'Tôi đi đây (sẽ quay lại)' }
        ];

        let vocabulary = [...initialVocabulary];
        let availableWords = [];
        let totalWordsForQuiz = 0;
        let totalScore = 0;
        let wordScores = {}; // Lưu điểm cho mỗi từ
        let currentWord = null;
        
        // Load vocabulary from local storage
        function loadCustomVocabulary() {
            const customWords = JSON.parse(localStorage.getItem('customVocabulary')) || [];
            vocabulary = [...initialVocabulary, ...customWords];
        }

        // Save vocabulary to local storage
        function saveCustomVocabulary(newWord) {
            const customWords = JSON.parse(localStorage.getItem('customVocabulary')) || [];
            customWords.push(newWord);
            localStorage.setItem('customVocabulary', JSON.stringify(customWords));
            loadCustomVocabulary(); // Reload all words
        }
        
        // Save scores to local storage
        function saveScores() {
            localStorage.setItem('totalScore', JSON.stringify(totalScore));
            localStorage.setItem('wordScores', JSON.stringify(wordScores));
        }

        // Load scores from local storage
        function loadScores() {
            totalScore = JSON.parse(localStorage.getItem('totalScore')) || 0;
            wordScores = JSON.parse(localStorage.getItem('wordScores')) || {};
            scoreDisplay.textContent = totalScore;
        }

        // Các phần tử DOM
        const homePage = document.getElementById('home-page');
        const quizPage = document.getElementById('quiz-page');
        const quizNavigation = document.getElementById('quiz-navigation');
        const addWordPage = document.getElementById('add-word-page');
        const fixedSizeQuizButtons = document.querySelectorAll('#home-page .option-button[data-quiz-size]');
        const addWordOptionButton = document.getElementById('add-word-option');
        const startCustomQuizButton = document.getElementById('start-custom-quiz');
        const customQuizInput = document.getElementById('custom-quiz-input');
        const backButton = document.getElementById('back-button');
        const japaneseWordEl = document.getElementById('japanese-word');
        const romajiEl = document.getElementById('romaji');
        const optionsContainer = document.getElementById('options-container');
        const nextButton = document.getElementById('next-button');
        const counterEl = document.getElementById('counter');
        const resultMessageEl = document.getElementById('result-message');
        const scoreDisplay = document.getElementById('score-display');
        const wordScoresBreakdown = document.getElementById('word-scores-breakdown');
        
        const japaneseInput = document.getElementById('japanese-input');
        const romajiInput = document.getElementById('romaji-input');
        const vietnameseInput = document.getElementById('vietnamese-input');
        const addButton = document.getElementById('add-button');
        const addMessage = document.getElementById('add-message');
        
        // Hàm xáo trộn mảng
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // Hàm kết thúc bài trắc nghiệm
        function endQuiz() {
            japaneseWordEl.textContent = 'Hoàn thành!';
            romajiEl.textContent = `Bạn đã hoàn thành bài kiểm tra với tổng điểm: ${totalScore}`;
            optionsContainer.innerHTML = '';
            resultMessageEl.textContent = 'Chúc mừng bạn đã hoàn thành tất cả các câu hỏi! 🎉';
            nextButton.classList.add('hidden');
            counterEl.textContent = '';
            
            // Hiển thị chi tiết điểm số của từng từ
            wordScoresBreakdown.classList.remove('hidden');
            let scoresHtml = '<h3>Chi tiết điểm số:</h3>';
            const learnedWords = Object.keys(wordScores);
            if (learnedWords.length > 0) {
                learnedWords.forEach(word => {
                    // Find the total occurrences of this word in the quiz
                    const totalOccurrences = availableWords.filter(w => w.japanese === word).length;
                    scoresHtml += `<div class="score-item"><span>${word}</span> <span>${wordScores[word]} / ${totalOccurrences}</span></div>`;
                });
            } else {
                scoresHtml += '<p>Chưa có từ nào được trả lời đúng.</p>';
            }
            wordScoresBreakdown.innerHTML = scoresHtml;
            
            saveScores(); // Lưu điểm số khi kết thúc quiz
        }

        // Tạo câu hỏi và các đáp án
        function generateQuestion() {
            wordScoresBreakdown.classList.add('hidden');
            
            // Check if all words have been used
            if (availableWords.length === 0) {
                endQuiz();
                return;
            }

            let nextWordIndex = Math.floor(Math.random() * availableWords.length);
            let nextWord = availableWords[nextWordIndex];
            
            // Đảm bảo từ mới không lặp lại từ vừa rồi
            if (currentWord && availableWords.length > 1) {
                while (nextWord.japanese === currentWord.japanese) {
                    nextWordIndex = Math.floor(Math.random() * availableWords.length);
                    nextWord = availableWords[nextWordIndex];
                }
            }

            currentWord = nextWord;
            availableWords.splice(nextWordIndex, 1);
            
            const correctAnswer = currentWord.vietnamese;

            const incorrectAnswers = [];
            const tempVocabulary = [...vocabulary].filter(word => word.japanese !== currentWord.japanese);
            shuffleArray(tempVocabulary);
            for (let i = 0; i < 3 && i < tempVocabulary.length; i++) {
                incorrectAnswers.push(tempVocabulary[i].vietnamese);
            }

            const allAnswers = [...incorrectAnswers, correctAnswer];
            shuffleArray(allAnswers);

            japaneseWordEl.textContent = currentWord.japanese;
            romajiEl.textContent = currentWord.romaji;
            optionsContainer.innerHTML = '';
            resultMessageEl.textContent = '';
            nextButton.classList.add('hidden');

            allAnswers.forEach(answer => {
                const button = document.createElement('button');
                button.textContent = answer;
                button.classList.add('option-button');
                button.addEventListener('click', () => checkAnswer(button, answer, correctAnswer));
                optionsContainer.appendChild(button);
            });
            
            // Update counter
            counterEl.textContent = `${totalWordsForQuiz - availableWords.length}/${totalWordsForQuiz}`;
        }

        // Kiểm tra đáp án
        function checkAnswer(button, selectedAnswer, correctAnswer) {
            const allButtons = document.querySelectorAll('.option-button');
            allButtons.forEach(btn => btn.disabled = true);

            if (selectedAnswer === correctAnswer) {
                button.classList.add('correct');
                resultMessageEl.textContent = 'Đúng rồi!';
                totalScore++;
                scoreDisplay.textContent = totalScore;
                
                // Ghi điểm cho từ cụ thể
                wordScores[currentWord.japanese] = (wordScores[currentWord.japanese] || 0) + 1;
                
                saveScores(); // Lưu điểm số ngay sau khi trả lời đúng
                
                setTimeout(generateQuestion, 1000);
            } else {
                button.classList.add('incorrect');
                resultMessageEl.textContent = `Sai rồi. Đáp án đúng là: ${correctAnswer}`;
                const correctButton = Array.from(allButtons).find(btn => btn.textContent === correctAnswer);
                if (correctButton) {
                    correctButton.classList.add('correct');
                }
                nextButton.classList.remove('hidden');
            }
        }

        // Chuyển đổi giữa các trang
        function showHomePage() {
            homePage.classList.remove('hidden');
            quizPage.classList.add('hidden');
            quizNavigation.classList.add('hidden');
            addWordPage.classList.add('hidden');
        }

        function showQuizPage() {
            homePage.classList.add('hidden');
            quizPage.classList.remove('hidden');
            quizNavigation.classList.remove('hidden');
            addWordPage.classList.add('hidden');
        }

        function showAddWordPage() {
            homePage.classList.add('hidden');
            quizPage.classList.add('hidden');
            quizNavigation.classList.remove('hidden');
            addWordPage.classList.remove('hidden');
            backButton.classList.remove('hidden'); // Ensure back button is visible
            nextButton.classList.add('hidden'); // Hide next button on this page
        }

        // Khởi tạo một bài quiz mới
        function startQuiz(quizSize) {
            totalWordsForQuiz = quizSize * 4; // Mỗi từ lặp lại 4 lần
            
            shuffleArray(vocabulary);
            const selectedWords = vocabulary.slice(0, quizSize);
            
            availableWords = [];
            // Thêm mỗi từ vào mảng 4 lần
            for (let i = 0; i < 4; i++) {
                availableWords.push(...selectedWords);
            }
            shuffleArray(availableWords);
            
            showQuizPage();
            generateQuestion();
        }

        // Sự kiện khi nhấn nút trên trang chủ
        fixedSizeQuizButtons.forEach(button => {
            button.addEventListener('click', (event) => {
                const quizSize = parseInt(event.target.dataset.quizSize);
                if (!isNaN(quizSize)) {
                    startQuiz(quizSize);
                }
            });
        });

        // Sự kiện khi nhấn nút "Bắt đầu" cho quiz tùy chỉnh
        startCustomQuizButton.addEventListener('click', () => {
            const quizSize = parseInt(customQuizInput.value.trim());

            if (isNaN(quizSize) || quizSize <= 0 || quizSize > vocabulary.length) {
                resultMessageEl.textContent = `Vui lòng nhập một số hợp lệ từ 1 đến ${vocabulary.length}.`;
                resultMessageEl.style.color = '#e74c3c';
                setTimeout(() => resultMessageEl.textContent = '', 3000);
                return;
            }
            startQuiz(quizSize);
        });
        
        // Sự kiện khi nhấn nút "Thêm từ mới"
        addWordOptionButton.addEventListener('click', showAddWordPage);

        // Sự kiện khi nhấn nút "Thêm từ"
        addButton.addEventListener('click', () => {
            const japanese = japaneseInput.value.trim();
            const romaji = romajiInput.value.trim();
            const vietnamese = vietnameseInput.value.trim();

            if (japanese && romaji && vietnamese) {
                const newWord = { japanese, romaji, vietnamese };
                saveCustomVocabulary(newWord);
                addMessage.textContent = 'Đã thêm từ thành công!';
                japaneseInput.value = '';
                romajiInput.value = '';
                vietnameseInput.value = '';
                
                // Clear message after a few seconds
                setTimeout(() => {
                    addMessage.textContent = '';
                }, 3000);
            } else {
                addMessage.textContent = 'Vui lòng nhập đủ các trường.';
                addMessage.style.color = '#e74c3c';
            }
        });

        // Sự kiện khi nhấn nút "Tiếp theo"
        nextButton.addEventListener('click', generateQuestion);

        // Sự kiện khi nhấn nút "Trang chủ"
        backButton.addEventListener('click', () => {
            availableWords = [];
            totalWordsForQuiz = 0;
            currentWord = null;
            showHomePage();
            resultMessageEl.textContent = ''; // Clear result message when going back to home
        });
        
        // Load custom vocabulary and scores initially
        document.addEventListener('DOMContentLoaded', () => {
            loadCustomVocabulary();
            loadScores();
            showHomePage();
        });
    </script>

</body>
</html>
