<!DOCTYPE html>
<html lang="vi" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Học tiếng Nhật N3 cá nhân hóa</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .main-content {
            padding-top: 6rem;
            min-height: 100vh;
        }
        .dark .bg-gray-800 { background-color: #1f2937; }
        .dark .bg-gray-900 { background-color: #111827; }
        .dark .text-gray-200 { color: #e5e7eb; }
        .dark .text-gray-400 { color: #9ca3af; }
        .dark .border-gray-700 { border-color: #374151; }
        .dark .hover\:bg-gray-700:hover { background-color: #374151; }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #4b5563;
            border-radius: 4px;
        }
        .dark ::-webkit-scrollbar-thumb {
            background-color: #9ca3af;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 transition-colors duration-300">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-75 transition-opacity duration-300">
        <div class="flex flex-col items-center">
            <svg class="animate-spin h-10 w-10 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 text-white text-lg font-semibold">Đang tải...</p>
        </div>
    </div>

    <!-- Message Modal -->
    <div id="message-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4 bg-gray-900 bg-opacity-75">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 id="modal-title" class="text-xl font-bold mb-4 text-gray-900 dark:text-gray-200">Thông báo</h3>
            <p id="modal-content" class="text-gray-700 dark:text-gray-400 mb-6"></p>
            <button onclick="closeModal()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200">OK</button>
        </div>
    </div>

    <!-- Header -->
    <header class="fixed top-0 left-0 right-0 z-40 bg-white dark:bg-gray-900 shadow-md">
        <div class="container mx-auto px-4 py-4 flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <a href="#dashboard" class="text-2xl font-bold text-indigo-600 dark:text-indigo-400">Nihongo N3</a>
                <span id="user-id-display" class="text-xs text-gray-500 dark:text-gray-400 p-1 bg-gray-200 dark:bg-gray-700 rounded-md truncate max-w-[150px] sm:max-w-none">ID người dùng: Đang tải...</span>
            </div>
            <nav class="hidden md:flex space-x-6">
                <a href="#dashboard" class="text-gray-600 dark:text-gray-300 hover:text-indigo-600 dark:hover:text-indigo-400 font-semibold transition-colors duration-200">Tổng quan</a>
                <a href="#vocabulary" class="text-gray-600 dark:text-gray-300 hover:text-indigo-600 dark:hover:text-indigo-400 font-semibold transition-colors duration-200">Từ vựng</a>
                <a href="#grammar" class="text-gray-600 dark:text-gray-300 hover:text-indigo-600 dark:hover:text-indigo-400 font-semibold transition-colors duration-200">Ngữ pháp</a>
                <a href="#quiz" class="text-gray-600 dark:text-gray-300 hover:text-indigo-600 dark:hover:text-indigo-400 font-semibold transition-colors duration-200">Bài kiểm tra</a>
            </nav>
            <button id="theme-toggle" class="p-2 rounded-full bg-gray-200 dark:bg-gray-800 text-gray-600 dark:text-gray-300 hover:text-indigo-600 dark:hover:text-indigo-400 transition-colors duration-200">
                <svg id="sun-icon" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707"></path>
                </svg>
                <svg id="moon-icon" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                </svg>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content container mx-auto p-4 transition-colors duration-300">

        <!-- Dashboard Section -->
        <section id="dashboard" class="active-section p-6 bg-white dark:bg-gray-800 rounded-lg shadow-xl mb-8">
            <h1 class="text-3xl font-bold text-gray-900 dark:text-gray-200 mb-4">Chào mừng đến với Nihongo N3</h1>
            <p class="text-gray-600 dark:text-gray-400 mb-6">Đây là ứng dụng cá nhân hóa giúp bạn học và ôn tập tiếng Nhật trình độ N3. Bạn có thể tự thêm và quản lý các bộ từ vựng và ngữ pháp của mình.</p>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <a href="#vocabulary" class="p-6 bg-indigo-500 rounded-lg shadow-md text-white hover:bg-indigo-600 transition-colors duration-200 transform hover:scale-105">
                    <h2 class="text-xl font-bold mb-2">Bộ từ vựng</h2>
                    <p class="text-sm">Thêm, xem và quản lý các bộ từ vựng cá nhân của bạn.</p>
                </a>
                <a href="#grammar" class="p-6 bg-green-500 rounded-lg shadow-md text-white hover:bg-green-600 transition-colors duration-200 transform hover:scale-105">
                    <h2 class="text-xl font-bold mb-2">Điểm ngữ pháp</h2>
                    <p class="text-sm">Tổ chức và ôn tập các điểm ngữ pháp N3 quan trọng.</p>
                </a>
                <a href="#quiz" class="p-6 bg-red-500 rounded-lg shadow-md text-white hover:bg-red-600 transition-colors duration-200 transform hover:scale-105">
                    <h2 class="text-xl font-bold mb-2">Bài kiểm tra</h2>
                    <p class="text-sm">Kiểm tra kiến thức của bạn với các bài kiểm tra tùy chỉnh.</p>
                </a>
            </div>
        </section>

        <!-- Vocabulary Section -->
        <section id="vocabulary" class="p-6 bg-white dark:bg-gray-800 rounded-lg shadow-xl hidden">
            <h1 class="text-3xl font-bold text-gray-900 dark:text-gray-200 mb-4">Quản lý Từ vựng</h1>
            <div class="mb-6 p-4 border border-dashed border-gray-300 dark:border-gray-700 rounded-lg text-center">
                <p class="text-gray-600 dark:text-gray-400 mb-2">Tải lên file văn bản (.txt) từ vựng của bạn. Mỗi dòng một từ, phân cách bằng '|'.</p>
                <code class="block bg-gray-200 dark:bg-gray-700 text-sm p-2 rounded-md overflow-x-auto text-gray-800 dark:text-gray-200 whitespace-nowrap">Kanji|Cách đọc (Kana)|Nghĩa tiếng Việt|Câu ví dụ|Dịch câu ví dụ</code>
                <label for="vocab-file-input" class="mt-4 inline-block bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg cursor-pointer transition duration-200">
                    <svg class="h-5 w-5 inline-block -mt-1 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                    Tải lên Bộ Từ Vựng mới
                </label>
                <input type="file" id="vocab-file-input" accept=".txt" class="hidden">
            </div>

            <div id="vocab-list">
                <h2 class="text-xl font-bold mb-4 text-gray-900 dark:text-gray-200">Các bộ từ vựng đã tải lên:</h2>
                <!-- Dynamic content will be injected here -->
            </div>
        </section>

        <!-- Grammar Section -->
        <section id="grammar" class="p-6 bg-white dark:bg-gray-800 rounded-lg shadow-xl hidden">
            <h1 class="text-3xl font-bold text-gray-900 dark:text-gray-200 mb-4">Quản lý Ngữ pháp</h1>
            <div class="mb-6 p-4 border border-dashed border-gray-300 dark:border-gray-700 rounded-lg text-center">
                <p class="text-gray-600 dark:text-gray-400 mb-2">Tải lên file văn bản (.txt) ngữ pháp của bạn. Mỗi dòng một điểm, phân cách bằng '|'.</p>
                <code class="block bg-gray-200 dark:bg-gray-700 text-sm p-2 rounded-md overflow-x-auto text-gray-800 dark:text-gray-200 whitespace-nowrap">Tên ngữ pháp|Ý nghĩa/Cách dùng|Cấu trúc câu|Câu ví dụ 1|Dịch ví dụ 1|...</code>
                <label for="grammar-file-input" class="mt-4 inline-block bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg cursor-pointer transition duration-200">
                    <svg class="h-5 w-5 inline-block -mt-1 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                    Tải lên Điểm Ngữ Pháp mới
                </label>
                <input type="file" id="grammar-file-input" accept=".txt" class="hidden">
            </div>

            <div id="grammar-list">
                <h2 class="text-xl font-bold mb-4 text-gray-900 dark:text-gray-200">Các bộ ngữ pháp đã tải lên:</h2>
                <!-- Dynamic content will be injected here -->
            </div>
        </section>

        <!-- Quiz Section -->
        <section id="quiz" class="p-6 bg-white dark:bg-gray-800 rounded-lg shadow-xl hidden">
            <h1 class="text-3xl font-bold text-gray-900 dark:text-gray-200 mb-4">Bài Kiểm Tra</h1>
            <div class="p-4 bg-gray-200 dark:bg-gray-700 rounded-lg text-center">
                <p class="text-gray-800 dark:text-gray-200 text-lg font-medium">Chức năng này sẽ được xây dựng dựa trên dữ liệu bạn đã tải lên.</p>
                <p class="text-gray-600 dark:text-gray-400 mt-2">Hãy bắt đầu bằng cách thêm các bộ từ vựng và ngữ pháp của bạn!</p>
            </div>
        </section>

    </main>

    <!-- Firebase Scripts -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, onSnapshot, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth, userId = null;

        // UI Elements
        const loadingOverlay = document.getElementById('loading-overlay');
        const userIdDisplay = document.getElementById('user-id-display');
        const messageModal = document.getElementById('message-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const vocabFileInput = document.getElementById('vocab-file-input');
        const grammarFileInput = document.getElementById('grammar-file-input');
        const vocabList = document.getElementById('vocab-list');
        const grammarList = document.getElementById('grammar-list');

        // Show/hide functions for UI elements
        const showLoading = () => loadingOverlay.classList.remove('hidden');
        const hideLoading = () => loadingOverlay.classList.add('hidden');
        const showModal = (title, content) => {
            modalTitle.textContent = title;
            modalContent.textContent = content;
            messageModal.classList.remove('hidden');
        };
        window.closeModal = () => messageModal.classList.add('hidden');

        // Navigation logic
        const sections = document.querySelectorAll('section');
        const navLinks = document.querySelectorAll('nav a');
        const dashboardLinks = document.querySelectorAll('#dashboard a');
        
        const showSection = (id) => {
            sections.forEach(section => {
                if ('#' + section.id === id) {
                    section.classList.remove('hidden');
                    section.classList.add('active-section');
                } else {
                    section.classList.add('hidden');
                    section.classList.remove('active-section');
                }
            });
            window.location.hash = id;
        };

        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                showSection(e.target.getAttribute('href'));
            });
        });

        dashboardLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                showSection(e.currentTarget.getAttribute('href'));
            });
        });

        // Initialize Firebase and Authentication
        const initFirebase = async () => {
            showLoading();
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    throw new Error("Firebase config not available. Please try again.");
                }

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Use onAuthStateChanged to handle auth state and data fetching
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = `ID người dùng: ${userId}`;
                        // Once user is authenticated, set up real-time listeners
                        setupRealtimeListeners();
                        hideLoading();
                        // Handle navigation to initial section
                        const hash = window.location.hash || '#dashboard';
                        showSection(hash);
                    } else {
                        // User is signed out or not signed in yet
                        console.log("No user signed in. Attempting to sign in...");
                        // Use provided custom token or sign in anonymously
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase Initialization or Auth Error:", error);
                showModal("Lỗi", "Không thể kết nối đến máy chủ. Vui lòng thử lại.");
                hideLoading();
            }
        };

        // Setup real-time listeners for Firestore data
        const setupRealtimeListeners = () => {
            if (!db || !userId) {
                console.error("Firestore or userId is not available.");
                return;
            }

            // Listen for changes to vocabulary sets
            const vocabColRef = collection(db, `artifacts/${appId}/users/${userId}/vocabulary_sets`);
            onSnapshot(vocabColRef, (snapshot) => {
                const sets = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderVocabSets(sets);
            }, (error) => {
                console.error("Error fetching vocab data:", error);
                showModal("Lỗi", "Không thể tải dữ liệu từ vựng.");
            });

            // Listen for changes to grammar sets
            const grammarColRef = collection(db, `artifacts/${appId}/users/${userId}/grammar_sets`);
            onSnapshot(grammarColRef, (snapshot) => {
                const sets = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderGrammarSets(sets);
            }, (error) => {
                console.error("Error fetching grammar data:", error);
                showModal("Lỗi", "Không thể tải dữ liệu ngữ pháp.");
            });
        };

        // File handling logic
        const handleFileChange = (event, type) => {
            const file = event.target.files[0];
            if (!file) return;

            showLoading();
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const content = e.target.result;
                    let parsedData;
                    if (type === 'vocab') {
                        parsedData = parseVocabFile(content);
                        if (parsedData.length > 0) {
                            await uploadData('vocabulary_sets', { items: parsedData });
                        }
                    } else if (type === 'grammar') {
                        parsedData = parseGrammarFile(content);
                        if (parsedData.length > 0) {
                            await uploadData('grammar_sets', { items: parsedData });
                        }
                    }
                    showModal("Thành công", `Đã tải lên ${parsedData.length} mục mới.`);
                } catch (error) {
                    console.error("Lỗi xử lý file:", error);
                    showModal("Lỗi", `Đã xảy ra lỗi khi xử lý file: ${error.message}`);
                } finally {
                    hideLoading();
                }
            };
            reader.readAsText(file);
        };

        // Data parsing functions
        const parseVocabFile = (content) => {
            const lines = content.split('\n').filter(line => line.trim() !== '');
            return lines.map(line => {
                const parts = line.split('|').map(p => p.trim());
                if (parts.length < 5) {
                    throw new Error(`Định dạng dòng không hợp lệ: "${line}". Cần ít nhất 5 trường.`);
                }
                return {
                    kanji: parts[0] || '',
                    kana: parts[1] || '',
                    meaning: parts[2] || '',
                    example: parts[3] || '',
                    translation: parts[4] || ''
                };
            });
        };

        const parseGrammarFile = (content) => {
            const lines = content.split('\n').filter(line => line.trim() !== '');
            return lines.map(line => {
                const parts = line.split('|').map(p => p.trim());
                if (parts.length < 3) {
                    throw new Error(`Định dạng dòng không hợp lệ: "${line}". Cần ít nhất 3 trường.`);
                }
                const examples = [];
                for (let i = 3; i < parts.length; i += 2) {
                    if (parts[i] && parts[i + 1]) {
                        examples.push({ example: parts[i], translation: parts[i + 1] });
                    }
                }
                return {
                    name: parts[0] || '',
                    meaning: parts[1] || '',
                    structure: parts[2] || '',
                    examples: examples
                };
            });
        };

        // Firestore data handling
        const uploadData = async (collectionName, data) => {
            if (!db || !userId) {
                showModal("Lỗi", "Chưa xác thực người dùng. Vui lòng thử lại.");
                return;
            }
            try {
                const colRef = collection(db, `artifacts/${appId}/users/${userId}/${collectionName}`);
                await addDoc(colRef, {
                    name: `Bộ mới - ${new Date().toLocaleString('vi-VN')}`,
                    createdAt: new Date(),
                    items: data.items,
                });
            } catch (error) {
                console.error("Lỗi khi tải dữ liệu lên Firestore:", error);
                throw new Error("Lỗi khi lưu dữ liệu. Vui lòng kiểm tra kết nối mạng.");
            }
        };

        // Render functions for UI
        const renderVocabSets = (sets) => {
            vocabList.innerHTML = `<h2 class="text-xl font-bold mb-4 text-gray-900 dark:text-gray-200">Các bộ từ vựng đã tải lên:</h2>`;
            if (sets.length === 0) {
                vocabList.innerHTML += `<p class="text-gray-500 dark:text-gray-400">Chưa có bộ từ vựng nào. Hãy tải lên bộ đầu tiên!</p>`;
                return;
            }
            sets.forEach(set => {
                const setName = set.name;
                const setSize = set.items.length;
                const vocabCard = document.createElement('div');
                vocabCard.className = 'p-4 my-2 bg-gray-50 dark:bg-gray-700 rounded-lg shadow-sm border border-gray-200 dark:border-gray-600 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 transition duration-200';
                vocabCard.innerHTML = `
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-200 truncate">${setName} (${setSize} từ)</h3>
                        <div class="flex items-center space-x-2">
                            <button class="delete-btn text-red-500 hover:text-red-700 transition" data-id="${set.id}" data-type="vocab">
                                <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-7 7-7-7"></path></svg>
                            </button>
                        </div>
                    </div>
                `;
                vocabList.appendChild(vocabCard);
            });
        };

        const renderGrammarSets = (sets) => {
            grammarList.innerHTML = `<h2 class="text-xl font-bold mb-4 text-gray-900 dark:text-gray-200">Các bộ ngữ pháp đã tải lên:</h2>`;
            if (sets.length === 0) {
                grammarList.innerHTML += `<p class="text-gray-500 dark:text-gray-400">Chưa có bộ ngữ pháp nào. Hãy tải lên bộ đầu tiên!</p>`;
                return;
            }
            sets.forEach(set => {
                const setName = set.name;
                const setSize = set.items.length;
                const grammarCard = document.createElement('div');
                grammarCard.className = 'p-4 my-2 bg-gray-50 dark:bg-gray-700 rounded-lg shadow-sm border border-gray-200 dark:border-gray-600 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 transition duration-200';
                grammarCard.innerHTML = `
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-200 truncate">${setName} (${setSize} điểm)</h3>
                        <div class="flex items-center space-x-2">
                            <button class="delete-btn text-red-500 hover:text-red-700 transition" data-id="${set.id}" data-type="grammar">
                                <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-7 7-7-7"></path></svg>
                            </button>
                        </div>
                    </div>
                `;
                grammarList.appendChild(grammarCard);
            });
        };

        // Event listeners
        vocabFileInput.addEventListener('change', (e) => handleFileChange(e, 'vocab'));
        grammarFileInput.addEventListener('change', (e) => handleFileChange(e, 'grammar'));

        // Delete functionality
        document.addEventListener('click', async (e) => {
            if (e.target.closest('.delete-btn')) {
                const button = e.target.closest('.delete-btn');
                const id = button.dataset.id;
                const type = button.dataset.type;
                const collectionName = type === 'vocab' ? 'vocabulary_sets' : 'grammar_sets';
                
                const confirmed = window.confirm('Bạn có chắc chắn muốn xóa bộ này không?');
                if (!confirmed) return;

                showLoading();
                try {
                    if (!db || !userId) {
                        showModal("Lỗi", "Chưa xác thực người dùng. Vui lòng thử lại.");
                        return;
                    }
                    const docRef = doc(db, `artifacts/${appId}/users/${userId}/${collectionName}`, id);
                    await deleteDoc(docRef);
                    showModal("Thành công", "Đã xóa bộ dữ liệu.");
                } catch (error) {
                    console.error("Lỗi khi xóa tài liệu:", error);
                    showModal("Lỗi", "Không thể xóa dữ liệu.");
                } finally {
                    hideLoading();
                }
            }
        });


        // Theme toggle logic
        const themeToggleBtn = document.getElementById('theme-toggle');
        const sunIcon = document.getElementById('sun-icon');
        const moonIcon = document.getElementById('moon-icon');

        themeToggleBtn.addEventListener('click', () => {
            document.documentElement.classList.toggle('dark');
            if (document.documentElement.classList.contains('dark')) {
                localStorage.setItem('theme', 'dark');
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
            } else {
                localStorage.setItem('theme', 'light');
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
            }
        });

        // Set initial theme from localStorage
        const setInitialTheme = () => {
            if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
            } else {
                document.documentElement.classList.remove('dark');
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
            }
        };

        window.onload = () => {
            setInitialTheme();
            initFirebase();
        };

    </script>
</body>
</html>
